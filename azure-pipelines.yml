trigger:
  - master

pool:
  name: 'Default'  # Use your self-hosted agent pool

variables:
  # Set node version used by the pipeline
  node_version: '18'
  # Epic configuration for vulnerability tickets
  vulnerabilityEpicId: '78'  # Replace with your Epic work item ID
  vulnerabilityEpicTitle: 'Security & Vulnerability Management'  # Your existing Epic title
  # Enable OAuth token access for work item creation
  system.accesstoken: $(System.AccessToken)
  
  # ðŸ¤– AI Provider Selection (true = Local/Private, false = Cloud)
  useLocalAI: true  # Set to false to use Groq cloud API instead

steps:
- checkout: self
  clean: true
  fetchDepth: 0

# Install Node and cache npm
- task: NodeTool@0
  inputs:
    versionSpec: '$(node_version)'
  displayName: 'Use Node.js $(node_version)'

# Verify FREE AI service (Ollama pre-installed on agent)
- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      Write-Host "##[section]ðŸ” Verifying FREE AI service on agent..."
      
      try {
        $health = Invoke-RestMethod -Uri "http://localhost:11434/api/tags" -TimeoutSec 5
        $modelCount = $health.models.Count
        $models = $health.models.name -join ', '
        
        Write-Host "##[section]âœ… Ollama running with $modelCount models: $models"
        
        # Verify CodeLlama is available for technical estimation
        if ($health.models | Where-Object { $_.name -like "codellama*" }) {
          Write-Host "##[section]ðŸŽ¯ CodeLlama ready for technical User Story estimation!"
        } else {
          Write-Host "##[warning]CodeLlama not found, will use available model"
        }
      }
      catch {
        Write-Host "##[error]Ollama not running on agent: $($_.Exception.Message)"
        Write-Host "##[section]ðŸ“‹ ONE-TIME Agent Setup Required:"
        Write-Host "##[section]   1. Install: winget install Ollama.Ollama"
        Write-Host "##[section]   2. Download model: ollama pull codellama:7b"
        Write-Host "##[section]   3. Setup auto-start (see Ollama-AutoStart-Setup.md)"
        Write-Host "##[section]   After setup, Ollama will start automatically!"
        exit 1
      }
  displayName: 'Verify FREE AI service (Agent Setup Required)'
  continueOnError: true

# Fast install with Windows optimizations - NEEDED FOR AUDIT
- script: |
    cd my-app
    echo "Installing dependencies with Windows optimizations..."
    npm config set fund false
    npm config set audit false
    npm install --no-optional --no-fund --silent
  displayName: 'npm install (Windows optimized)'

# Skip tests for speed - uncomment if needed
# - script: |
#     cd my-app
#     npm test -- --coverage --ci --watchAll=false
#   displayName: 'Run tests with coverage'

# Security audit and vulnerability check - TEMPORARILY DISABLED (npm registry issues)
# - task: PowerShell@2
#   inputs:
#     targetType: 'inline'
#     script: |
#       Set-Location "my-app"
#       
#       $auditFile = "audit-results.txt"
#       $auditJsonFile = "audit-results.json"
#       $projectName = "$(Build.Repository.Name)"
#       
#       Write-Host "##[section]Running npm audit for $projectName..."
#       
#       try {
#         # Run audit and capture both text and JSON output
#         npm audit --omit=dev --audit-level=moderate > $auditFile
#         npm audit --omit=dev --audit-level=moderate --json > $auditJsonFile
#         
#         Write-Host "##[debug]Audit files created:"
#         Write-Host "##[debug]  - Text: $(Test-Path $auditFile)"
#         Write-Host "##[debug]  - JSON: $(Test-Path $auditJsonFile)"
#       }
#       finally {
#         # Always show the audit report
#         if (Test-Path $auditFile) {
#           $report = Get-Content -Path $auditFile -Raw
#           Write-Host "##[section]=== NPM AUDIT REPORT ==="
#           Write-Host $report
#           Write-Host "##[section]==========================="
#           
#           # Check for vulnerabilities but don't fail the pipeline
#           if ($LASTEXITCODE -ne 0) {
#             $scanInfo = $report | Select-String "scanned.*packages" | Select-Object -First 1
#             if ($scanInfo) {
#               Write-Host "##vso[task.logissue type=warning]$projectName : $($scanInfo.Line)"
#             }
#             Write-Host "##[warning]Vulnerabilities found - will create work items"
#           } else {
#             Write-Host "##[section]âœ… No vulnerabilities found!"
#           }
#         }
#         
#         # Reset exit code to continue pipeline
#         $LASTEXITCODE = 0
#         Write-Host "##[debug]Audit scan completed successfully"
#       }
#     workingDirectory: '$(Build.SourcesDirectory)'
#   displayName: 'Security vulnerability scan (robust)'

# SonarCloud analysis: prepare, run analysis, publish (DISABLED FOR NOW)
# - task: SonarCloudPrepare@1
#   inputs:
#     SonarCloud: 'sonar'
#     organization: 'ap12324546'
#     scannerMode: 'CLI'
#     configMode: 'manual'
#     cliProjectKey: 'ap12324546_AP54'
#     cliProjectName: 'AP54'
#     extraProperties: |
#       sonar.sources=my-app/src
#       sonar.exclusions=**/node_modules/**,**/build/**,**/coverage/**
#       sonar.javascript.lcov.reportPaths=my-app/coverage/lcov.info
#   displayName: 'Prepare SonarCloud analysis'

# Run the build (CRA build) from the my-app folder - COMMENTED OUT FOR NOW
# - script: |
#     cd my-app
#     echo "Starting build..."
#     npm run build
#   displayName: 'Build (npm run build)'

# Quick build verification (PowerShell) - COMMENTED OUT SINCE BUILD IS DISABLED
# - task: PowerShell@2
#   inputs:
#     targetType: 'inline'
#     script: |
#       Set-Location "my-app"
#       
#       if (-not (Test-Path "build")) {
#         Write-Host "##[error]Build directory not found!"
#         exit 1
#       }
#       
#       if (-not (Test-Path "build/index.html")) {
#         Write-Host "##[error]index.html not found in build directory!"
#         exit 1
#       }
#       
#       Write-Host "##[section]âœ… Build verification successful"
#       Write-Host "Build contents:"
#       Get-ChildItem "build" | Format-Table Name, Length, LastWriteTime
#   displayName: 'Verify build artifacts'

# TEMPORARILY DISABLED - Ensure Epic exists for vulnerability tickets
# - task: PowerShell@2
#   inputs:
#     targetType: 'inline'
#     script: |
#       $headers = @{
#         'Authorization' = "Bearer $(System.AccessToken)"
#         'Content-Type' = 'application/json-patch+json'
#       }
#       
#       $org = "$(System.TeamFoundationCollectionUri)".TrimEnd('/')
#       $project = [System.Uri]::EscapeDataString("$(System.TeamProject)")
#       $epicId = "$(vulnerabilityEpicId)"
#       $epicTitle = "$(vulnerabilityEpicTitle)"
#       
#       # Check if Epic exists
#       $epicUrl = "$org/$project/_apis/wit/workitems/$epicId" + "?api-version=6.0"
#       
#       try {
#         $epic = Invoke-RestMethod -Uri $epicUrl -Method GET -Headers @{'Authorization' = "Bearer $(System.AccessToken)"}
#         Write-Host "##[section]âœ… Epic #$epicId already exists: $($epic.fields.'System.Title')"
#       }
#       catch {
#         Write-Host "##[warning]Epic #$epicId not found. Creating it..."
#         
#         # Create Epic work item
#         $epicData = @(
#           @{
#             op = "add"
#             path = "/fields/System.Title"
#             value = $epicTitle
#           },
#           @{
#             op = "add"
#             path = "/fields/System.WorkItemType"
#             value = "Epic"
#           },
#           @{
#             op = "add"
#             path = "/fields/System.Description"
#             value = "Epic for tracking security vulnerabilities and their fixes"
#           },
#           @{
#             op = "add"
#             path = "/fields/System.Tags"
#             value = "security; vulnerability; automated"
#           }
#         )
#         
#         $epicJson = $epicData | ConvertTo-Json -Depth 4
#         $createEpicUrl = "$org/$project/_apis/wit/workitems/`$Epic?api-version=6.0"
#         
#         try {
#           $newEpic = Invoke-RestMethod -Uri $createEpicUrl -Method POST -Headers $headers -Body $epicJson
#           Write-Host "##[section]âœ… Created Epic #$($newEpic.id): $($newEpic.fields.'System.Title')"
#           Write-Host "##vso[task.setvariable variable=vulnerabilityEpicId]$($newEpic.id)"
#         }
#         catch {
#           Write-Host "##[error]Failed to create Epic: $($_.Exception.Message)"
#           Write-Host "##[warning]Will create Bug items without Epic relationship"
#         }
#       }
#   displayName: 'Create or verify Epic for vulnerabilities'
#   continueOnError: true

# TEMPORARILY DISABLED - Create work items for vulnerabilities under Epic
# - task: PowerShell@2
#   timeoutInMinutes: 2
#   inputs:
#     targetType: 'filePath'
#     filePath: 'scripts/Security-VulnerabilityTickets.ps1'
#     arguments: >
#       -EpicId "$(vulnerabilityEpicId)"
#       -EpicTitle "$(vulnerabilityEpicTitle)" 
#       -Organization "$(System.TeamFoundationCollectionUri)"
#       -Project "$(System.TeamProject)"
#       -AccessToken "$(System.AccessToken)"
#       -AuditFile "my-app/audit-results.json"
#       -RepositoryName "$(Build.Repository.Name)"
#     workingDirectory: '$(Build.SourcesDirectory)'
#   displayName: 'Create vulnerability Issue items under Epic #$(vulnerabilityEpicId)'
#   continueOnError: true

# ðŸ†“ FREE AI User Story Estimation (Local Ollama)
- task: PowerShell@2
  inputs:
    targetType: 'filePath'
    filePath: 'scripts/AI-StoryPointEstimation.ps1'
    arguments: >
      -Organization "$(System.TeamFoundationCollectionUri)"
      -Project "$(System.TeamProject)"
      -AccessToken "$(System.AccessToken)"
      -LogFile "ai-estimation.log"
      -AIProvider "$(if ($env:USELOCALAI -eq 'true') { 'Ollama' } else { 'Groq' })"
      -OllamaEndpoint "http://localhost:11434"
      -OllamaModel "llama3.2:3b"
      -GroqApiKey "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"
      -GroqModel "llama-3.1-8b-instant"
    workingDirectory: '$(Build.SourcesDirectory)'
  env:
    USELOCALAI: $(useLocalAI)
  displayName: 'AI Story Point Estimation'
  continueOnError: true

# Create placeholder files to ensure artifacts exist
- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      # Ensure log files exist for artifact publishing
      if (-not (Test-Path "vulnerability-processing.log")) {
        "No vulnerability processing log was created." | Set-Content "vulnerability-processing.log"
      }
      if (-not (Test-Path "work-item-results.json")) {
        '{"message":"No results file was created","timestamp":"' + (Get-Date -Format "yyyy-MM-dd HH:mm:ss") + '"}' | Set-Content "work-item-results.json"
      }
      if (-not (Test-Path "ai-estimation.log")) {
        "No AI estimation log was created." | Set-Content "ai-estimation.log"
      }
      
      Write-Host "##[section]Files available for artifacts:"
      Get-ChildItem -Filter "*.log" | ForEach-Object { Write-Host "  - $($_.Name)" }
      Get-ChildItem -Filter "*.json" | ForEach-Object { Write-Host "  - $($_.Name)" }
  displayName: 'Ensure artifact files exist'
  condition: always()

# Publish debug artifacts
# - task: PublishBuildArtifacts@1
#   inputs:
#     PathtoPublish: 'vulnerability-processing.log'
#     ArtifactName: 'debug-logs'
#     publishLocation: 'Container'
#   displayName: 'Publish vulnerability processing log'
#   condition: always()

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: 'work-item-results.json'
    ArtifactName: 'debug-results'
    publishLocation: 'Container'
  displayName: 'Publish work item results'
  condition: always()

# COMMENTED OUT - Audit results not generated since audit step is disabled
# - task: PublishBuildArtifacts@1
#   inputs:
#     PathtoPublish: 'my-app/audit-results.json'
#     ArtifactName: 'audit-data'
#     publishLocation: 'Container'
#   displayName: 'Publish audit results'
#   condition: succeededOrFailed()

# - task: SonarCloudAnalyze@1
#   displayName: 'Run SonarCloud analysis'

# - task: SonarCloudPublish@1
#   inputs:
#     pollingTimeoutSec: '300'
#   displayName: 'Publish SonarCloud Quality Gate Result'

# Publish build artifact - COMMENTED OUT SINCE BUILD IS DISABLED
# - task: PublishBuildArtifacts@1
#   inputs:
#     PathtoPublish: 'my-app/build'
#     ArtifactName: 'webapp'
#     publishLocation: 'Container'
#   displayName: 'Publish build artifact'
